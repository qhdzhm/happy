import React, { useState, useEffect } from 'react';
import { Table, Card, Button, DatePicker, Space, Typography, Tag, message, Switch, Tooltip } from 'antd';
import { PrinterOutlined, ExportOutlined, MergeCellsOutlined } from '@ant-design/icons';
import dayjs from 'dayjs';
import * as tourAssignmentAPI from '@/api/tourAssignment';

const { Title } = Typography;

const AssignmentTable = () => {
  const [loading, setLoading] = useState(false);
  const [assignments, setAssignments] = useState([]);
  const [selectedDate, setSelectedDate] = useState(dayjs());
  const [enableMerge, setEnableMerge] = useState(true); // ÈªòËÆ§ÂêØÁî®Âú∞ÁÇπÂêàÂπ∂

  useEffect(() => {
    fetchAssignments();
  }, [selectedDate, enableMerge]);

  // Âú∞ÁÇπÂêàÂπ∂ËßÑÂàôÈÖçÁΩÆ
  const mergeRules = {
    // ‰∫öÁëüÊ∏ØÁõ∏ÂÖ≥Âú∞ÁÇπÂèØ‰ª•ÂêàÂπ∂
    '‰∫öÁëüÊ∏Ø': ['‰∫öÁëüÊ∏Ø', '‰∫öÁëüÊ∏Ø(ËøÖ)', '‰∫öÁëüÊ∏Ø(‰∏ç)', '‰∫ö(ËøÖ)', '‰∫ö(‰∏ç)', '‰∫ö'],
    // Áéõ‰∏Ω‰∫öÂ≤õÂíåÈÖíÊùØÊπæÂèØ‰ª•ÂêàÂπ∂ÔºàÁªèÂ∏∏‰∏ÄËµ∑Ê∏∏ËßàÔºâ
    'Áéõ‰∏Ω‰∫öÂ≤õ+ÈÖíÊùØÊπæ': ['Áéõ‰∏Ω‰∫öÂ≤õ', 'Áéõ', 'ÈÖíÊùØÊπæ', 'ÈÖí', 'ÈÖí(ÂæíÊ≠•)', 'ÈÖí(ËßÇÊôØ)'],
    // Â∏ÉÈ≤ÅÂ∞ºÂ≤õÁõ∏ÂÖ≥
    'Â∏ÉÈ≤ÅÂ∞ºÂ≤õ': ['Â∏ÉÈ≤ÅÂ∞ºÂ≤õ', 'Â∏É'],
    // ÈúçÂ∑¥ÁâπÁõ∏ÂÖ≥
    'ÈúçÂ∑¥Áâπ': ['ÈúçÂ∑¥Áâπ', 'Èúç'],
    // ÊëáÁØÆÂ±±Áõ∏ÂÖ≥
    'ÊëáÁØÆÂ±±': ['ÊëáÁØÆÂ±±', 'Êëá'],
    // ÊúóÂ°ûÊñØÈ°øÁõ∏ÂÖ≥
    'ÊúóÂ°ûÊñØÈ°ø': ['ÊúóÂ°ûÊñØÈ°ø', 'Êúó']
  };

  // Ëé∑ÂèñÂú∞ÁÇπÁöÑÂêàÂπ∂ÁªÑ
  const getMergeGroup = (destination) => {
    for (const [groupName, locations] of Object.entries(mergeRules)) {
      if (locations.includes(destination)) {
        return groupName;
      }
    }
    return destination; // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÁöÑÂêàÂπ∂ËßÑÂàôÔºåËøîÂõûÂéüÂú∞ÁÇπ
  };

  // Êô∫ËÉΩÂêàÂπ∂Âêå‰∏ÄÂØºÊ∏∏ÁöÑÁõ∏‰ººÂú∞ÁÇπ
  const mergeAssignmentsByGuideAndLocation = (assignments) => {
    if (!assignments || assignments.length === 0) return [];

    // ÊåâÂØºÊ∏∏ÂàÜÁªÑ
    const guideGroups = {};
    assignments.forEach(assignment => {
      const guideKey = assignment.guide?.guideId || 'unknown';
      if (!guideGroups[guideKey]) {
        guideGroups[guideKey] = [];
      }
      guideGroups[guideKey].push(assignment);
    });

    const mergedAssignments = [];

    // ÂØπÊØè‰∏™ÂØºÊ∏∏ÁöÑÂàÜÈÖçËøõË°åÂú∞ÁÇπÂêàÂπ∂
    Object.values(guideGroups).forEach(guideAssignments => {
      // ÊåâÂêàÂπ∂ÁªÑÂàÜÁ±ª
      const locationGroups = {};
      guideAssignments.forEach(assignment => {
        const mergeGroup = getMergeGroup(assignment.destination);
        if (!locationGroups[mergeGroup]) {
          locationGroups[mergeGroup] = [];
        }
        locationGroups[mergeGroup].push(assignment);
      });

      // ÂêàÂπ∂ÊØè‰∏™Âú∞ÁÇπÁªÑ
      Object.entries(locationGroups).forEach(([groupName, groupAssignments]) => {
        if (groupAssignments.length === 1) {
          // Âçï‰∏™Âú∞ÁÇπÔºåÁõ¥Êé•Ê∑ªÂä†
          mergedAssignments.push(groupAssignments[0]);
        } else {
          // Â§ö‰∏™Âú∞ÁÇπÈúÄË¶ÅÂêàÂπ∂
          const baseAssignment = groupAssignments[0];
          
          // ÂêàÂπ∂Êï∞ÊçÆ
          const mergedAssignment = {
            ...baseAssignment,
            id: `merged_${baseAssignment.guide?.guideId}_${groupName}`, // ÁîüÊàêÂîØ‰∏ÄID
            destination: groupName,
            // ÂêàÂπ∂Ê∏∏ÂÆ¢Êï∞Èáè
            totalPeople: groupAssignments.reduce((sum, a) => sum + (a.totalPeople || 0), 0),
            adultCount: groupAssignments.reduce((sum, a) => sum + (a.adultCount || 0), 0),
            childCount: groupAssignments.reduce((sum, a) => sum + (a.childCount || 0), 0),
            // ÂêàÂπ∂ÂÖ∑‰ΩìÂú∞ÁÇπ‰ø°ÊÅØÔºàÁî®‰∫éÊòæÁ§∫ËØ¶ÊÉÖÔºâ
            mergedDestinations: groupAssignments.map(a => a.destination),
            originalAssignments: groupAssignments, // ‰øùÁïôÂéüÂßãÊï∞ÊçÆ
            isMerged: true, // Ê†áËÆ∞‰∏∫ÂêàÂπ∂ËÆ∞ÂΩï
            // ÂêàÂπ∂ÁâπÊÆäË¶ÅÊ±Ç
            specialRequirements: [...new Set(
              groupAssignments.flatMap(a => a.specialRequirements || [])
            )],
            // ÂêàÂπ∂Â§áÊ≥®
            remarks: groupAssignments
              .map(a => a.remarks)
              .filter(r => r && r.trim())
              .join('; ') || null
          };

          console.log(`üîÑ ÂêàÂπ∂Âú∞ÁÇπ: ${groupAssignments.map(a => a.destination).join(' + ')} ‚Üí ${groupName}`, {
            ÂØºÊ∏∏: baseAssignment.guide?.guideName,
            ÂéüÂßãËÆ∞ÂΩïÊï∞: groupAssignments.length,
            ÂêàÂπ∂Âêé‰∫∫Êï∞: mergedAssignment.totalPeople
          });

          mergedAssignments.push(mergedAssignment);
        }
      });
    });

    return mergedAssignments;
  };

  // Ëé∑ÂèñÊåáÂÆöÊó•ÊúüÁöÑÂàÜÈÖçËÆ∞ÂΩï
  const fetchAssignments = async () => {
    if (!selectedDate) return;
    
    setLoading(true);
    try {
      const dateStr = selectedDate.format('YYYY-MM-DD');
      const response = await tourAssignmentAPI.getAssignmentsByDate(dateStr);
      
      if (response.code === 1) {
        const originalAssignments = response.data || [];
        
        let finalAssignments = originalAssignments;
        
        if (enableMerge) {
          // Â∫îÁî®Êô∫ËÉΩÂêàÂπ∂ÈÄªËæë
          finalAssignments = mergeAssignmentsByGuideAndLocation(originalAssignments);
          
          console.log('üìä Âú∞ÁÇπÂêàÂπ∂ÁªüËÆ°:', {
            ÂéüÂßãËÆ∞ÂΩïÊï∞: originalAssignments.length,
            ÂêàÂπ∂ÂêéËÆ∞ÂΩïÊï∞: finalAssignments.length,
            ËäÇÁúÅËÆ∞ÂΩïÊï∞: originalAssignments.length - finalAssignments.length
          });
        } else {
          console.log('üìä Âú∞ÁÇπÂêàÂπ∂Â∑≤Á¶ÅÁî®ÔºåÊòæÁ§∫ÂéüÂßãËÆ∞ÂΩï:', originalAssignments.length);
        }
        
        setAssignments(finalAssignments);
      } else {
        message.error(response.msg || 'Ëé∑ÂèñÂàÜÈÖçËÆ∞ÂΩïÂ§±Ë¥•');
      }
    } catch (error) {
      message.error('Ëé∑ÂèñÂàÜÈÖçËÆ∞ÂΩïÂ§±Ë¥•');
      console.error('Ëé∑ÂèñÂàÜÈÖçËÆ∞ÂΩïÂ§±Ë¥•:', error);
    } finally {
      setLoading(false);
    }
  };

  // Ë°®Ê†ºÂàóÂÆö‰πâ - Ê®°Êãü"Âõæ2"ÁöÑË°®Ê†ºÁªìÊûÑ
  const columns = [
    {
      title: 'Â∫èÂè∑',
      key: 'index',
      width: 60,
      render: (_, __, index) => index + 1,
      align: 'center'
    },
    {
      title: 'ÁõÆÁöÑÂú∞',
      dataIndex: 'destination',
      key: 'destination',
      width: 150,
      align: 'center',
      render: (destination, record) => (
        <div>
          <div style={{ fontWeight: 'bold', fontSize: '14px' }}>
            {destination}
          </div>
          {record.isMerged && record.mergedDestinations && (
            <div style={{ 
              fontSize: '11px', 
              color: '#666', 
              marginTop: '2px',
              background: '#f0f9ff',
              padding: '2px 4px',
              borderRadius: '3px',
              border: '1px solid #e0f2fe'
            }}>
              ÂêàÂπ∂: {record.mergedDestinations.join(' + ')}
            </div>
          )}
          {record.isMerged && (
            <Tag size="small" color="blue" style={{ marginTop: '2px' }}>
              Â∑≤ÂêàÂπ∂ ({record.originalAssignments?.length || 0})
            </Tag>
          )}
        </div>
      )
    },
    {
      title: 'ÂØºÊ∏∏‰ø°ÊÅØ',
      key: 'guideInfo',
      width: 150,
      render: (_, record) => (
        <div style={{ textAlign: 'left' }}>
          <div style={{ fontWeight: 'bold' }}>{record.guide?.guideName}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>{record.guide?.phone}</div>
          {record.guide?.languages && (
            <div style={{ fontSize: '12px', color: '#1890ff' }}>
              ËØ≠Ë®Ä: {record.guide.languages}
            </div>
          )}
        </div>
      )
    },
    {
      title: 'ËΩ¶ËæÜ‰ø°ÊÅØ',
      key: 'vehicleInfo',
      width: 130,
      render: (_, record) => (
        <div style={{ textAlign: 'left' }}>
          <div style={{ fontWeight: 'bold' }}>{record.vehicle?.licensePlate}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            {record.vehicle?.vehicleType}
          </div>
          <div style={{ fontSize: '12px', color: '#52c41a' }}>
            {record.vehicle?.seatCount}Â∫ß
          </div>
        </div>
      )
    },
    {
      title: 'Ê∏∏ÂÆ¢‰∫∫Êï∞',
      key: 'peopleInfo',
      width: 120,
      align: 'center',
      render: (_, record) => (
        <div>
          <div style={{ fontWeight: 'bold', fontSize: '16px', color: record.isMerged ? '#1890ff' : '#000' }}>
            {record.totalPeople}‰∫∫
          </div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            Êàê‰∫∫: {record.adultCount}
          </div>
          <div style={{ fontSize: '12px', color: '#666' }}>
            ÂÑøÁ´•: {record.childCount}
          </div>
          {record.isMerged && (
            <div style={{ 
              fontSize: '10px', 
              color: '#1890ff',
              marginTop: '2px',
              fontStyle: 'italic'
            }}>
              ÂêàÂπ∂ÊÄªÊï∞
            </div>
          )}
        </div>
      )
    },
    {
      title: 'ËÅîÁ≥ª‰ø°ÊÅØ',
      key: 'contactInfo',
      width: 140,
      render: (_, record) => (
        <div style={{ textAlign: 'left' }}>
          <div style={{ fontWeight: 'bold' }}>{record.contactPerson}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>{record.contactPhone}</div>
        </div>
      )
    },
    {
      title: 'Êé•ÈÄÅ‰ø°ÊÅØ',
      key: 'pickupInfo',
      width: 150,
      render: (_, record) => (
        <div style={{ textAlign: 'left' }}>
          {record.pickupLocation && (
            <div style={{ fontSize: '12px' }}>
              <span style={{ color: '#666' }}>Êé•:</span> {record.pickupLocation}
            </div>
          )}
          {record.dropoffLocation && (
            <div style={{ fontSize: '12px' }}>
              <span style={{ color: '#666' }}>ÈÄÅ:</span> {record.dropoffLocation}
            </div>
          )}
          {record.pickupMethod && (
            <div style={{ fontSize: '12px', color: '#1890ff' }}>
              ÊñπÂºè: {getPickupMethodText(record.pickupMethod)}
            </div>
          )}
        </div>
      )
    },
    {
      title: 'ÁâπÊÆäÈúÄÊ±Ç',
      key: 'requirements',
      width: 120,
      render: (_, record) => {
        const requirements = [];
        if (record.specialRequirements) requirements.push('ÁâπÊÆäË¶ÅÊ±Ç');
        if (record.dietaryRestrictions) requirements.push('È•ÆÈ£üÈôêÂà∂');
        if (record.emergencyContact) requirements.push('Á¥ßÊÄ•ËÅîÁ≥ª');
        
        return (
          <div>
            {requirements.length > 0 ? (
              requirements.map(req => (
                <Tag key={req} size="small" color="orange" style={{ margin: '1px' }}>
                  {req}
                </Tag>
              ))
            ) : (
              <span style={{ color: '#ccc' }}>Êó†</span>
            )}
          </div>
        );
      }
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      width: 80,
      align: 'center',
      render: (status) => {
        const statusConfig = {
          confirmed: { color: 'green', text: 'Â∑≤Á°ÆËÆ§' },
          in_progress: { color: 'blue', text: 'ËøõË°å‰∏≠' },
          completed: { color: 'purple', text: 'Â∑≤ÂÆåÊàê' },
          cancelled: { color: 'red', text: 'Â∑≤ÂèñÊ∂à' }
        };
        const config = statusConfig[status] || { color: 'default', text: status };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    },
    {
      title: 'Â§áÊ≥®',
      dataIndex: 'remarks',
      key: 'remarks',
      width: 120,
      ellipsis: true,
      render: (text, record) => (
        <div>
          {text || '-'}
          {record.isMerged && record.originalAssignments?.length > 1 && (
            <div style={{ 
              fontSize: '10px', 
              color: '#666',
              marginTop: '2px',
              fontStyle: 'italic'
            }}>
              Êù•Ëá™{record.originalAssignments.length}‰∏™ÂéüÂßãËÆ∞ÂΩï
            </div>
          )}
        </div>
      )
    }
  ];

  // Êé•ÈÄÅÊñπÂºèÊñáÊú¨ËΩ¨Êç¢
  const getPickupMethodText = (method) => {
    const methodMap = {
      hotel_pickup: 'ÈÖíÂ∫óÊé•ÈÄÅ',
      meeting_point: 'ÈõÜÂêàÁÇπ',
      self_drive: 'Ëá™È©æ',
      other: 'ÂÖ∂‰ªñ'
    };
    return methodMap[method] || method;
  };

  // ÊâìÂç∞ÂäüËÉΩ
  const handlePrint = () => {
    window.print();
  };

  // ÂØºÂá∫ÂäüËÉΩ
  const handleExport = async () => {
    try {
      const dateStr = selectedDate.format('YYYY-MM-DD');
      const response = await tourAssignmentAPI.exportAssignments({
        startDate: dateStr,
        endDate: dateStr
      });
      
      if (response.code === 1) {
        message.success('ÂØºÂá∫ÊàêÂäü');
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êñá‰ª∂‰∏ãËΩΩÈÄªËæë
      } else {
        message.error(response.msg || 'ÂØºÂá∫Â§±Ë¥•');
      }
    } catch (error) {
      message.error('ÂØºÂá∫Â§±Ë¥•');
    }
  };

  // ËÆ°ÁÆóÁªüËÆ°‰ø°ÊÅØ
  const statistics = {
    totalAssignments: assignments.length,
    totalGuides: new Set(assignments.map(a => a.guide?.guideId)).size,
    totalVehicles: new Set(assignments.map(a => a.vehicle?.vehicleId)).size,
    totalPeople: assignments.reduce((sum, a) => sum + (a.totalPeople || 0), 0),
    destinations: [...new Set(assignments.map(a => a.destination))].join(', ')
  };

  return (
    <div className="assignment-table-page">
      <Card>
        {/* Â§¥ÈÉ®‰ø°ÊÅØ */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: 16,
          padding: '16px 0',
          borderBottom: '2px solid #f0f0f0'
        }}>
          <div>
            <Title level={3} style={{ margin: 0 }}>
              ÊóÖÊ∏∏Âõ¢ÂØºÊ∏∏ËΩ¶ËæÜÂàÜÈÖçË°®
            </Title>
            <div style={{ marginTop: 8, color: '#666' }}>
              <Space>
                <span>Êó•ÊúüÔºö</span>
                <DatePicker 
                  value={selectedDate}
                  onChange={setSelectedDate}
                  format="YYYYÂπ¥MMÊúàDDÊó•"
                />
                <Tooltip 
                  title="ÂêØÁî®ÂêéÔºåÂêå‰∏ÄÂØºÊ∏∏ÁöÑÁõ∏‰ººÂú∞ÁÇπÔºàÂ¶ÇÔºö‰∫öÁëüÊ∏Ø+‰∫öÁëüÊ∏ØËøÖÊ∏∏ÔºåÁéõ‰∏Ω‰∫öÂ≤õ+ÈÖíÊùØÊπæÔºâÂ∞ÜÊô∫ËÉΩÂêàÂπ∂‰∏∫‰∏Ä‰∏™ÂçïÂ≠ê"
                  placement="top"
                >
                  <Space>
                    <MergeCellsOutlined style={{ color: enableMerge ? '#1890ff' : '#ccc' }} />
                    <span>Êô∫ËÉΩÂêàÂπ∂Ôºö</span>
                    <Switch 
                      checked={enableMerge}
                      onChange={setEnableMerge}
                      size="small"
                    />
                  </Space>
                </Tooltip>
              </Space>
            </div>
          </div>
          <Space>
            <Button icon={<PrinterOutlined />} onClick={handlePrint}>
              ÊâìÂç∞
            </Button>
            <Button icon={<ExportOutlined />} onClick={handleExport}>
              ÂØºÂá∫
            </Button>
          </Space>
        </div>

        {/* ÁªüËÆ°‰ø°ÊÅØ */}
        <div style={{ 
          background: '#fafafa', 
          padding: '12px 16px',
          marginBottom: 16,
          borderRadius: '6px',
          fontSize: '14px'
        }}>
          <Space wrap>
            <span>ÊÄªÂàÜÈÖçÊï∞Ôºö<strong>{statistics.totalAssignments}</strong></span>
            <span>ÂØºÊ∏∏Êï∞Ôºö<strong>{statistics.totalGuides}</strong></span>
            <span>ËΩ¶ËæÜÊï∞Ôºö<strong>{statistics.totalVehicles}</strong></span>
            <span>Ê∏∏ÂÆ¢ÊÄªÊï∞Ôºö<strong>{statistics.totalPeople}</strong>‰∫∫</span>
            {statistics.destinations && (
              <span>ÁõÆÁöÑÂú∞Ôºö<strong>{statistics.destinations}</strong></span>
            )}
          </Space>
        </div>

        {/* ÂàÜÈÖçË°®Ê†º */}
        <Table
          columns={columns}
          dataSource={assignments}
          loading={loading}
          pagination={false}
          rowKey="id"
          scroll={{ x: 1200 }}
          size="small"
          bordered
          className="assignment-detail-table"
          locale={{
            emptyText: selectedDate ? `${selectedDate.format('YYYYÂπ¥MMÊúàDDÊó•')} ÊöÇÊó†ÂàÜÈÖçËÆ∞ÂΩï` : 'ËØ∑ÈÄâÊã©Êó•Êúü'
          }}
        />

        {/* È°µËÑöËØ¥Êòé */}
        <div style={{ 
          marginTop: 16, 
          textAlign: 'center', 
          color: '#999',
          fontSize: '12px',
          borderTop: '1px solid #f0f0f0',
          paddingTop: '16px'
        }}>
          <div>Happy Tassie Travel - ÊóÖÊ∏∏Âõ¢ÂàÜÈÖçÁÆ°ÁêÜÁ≥ªÁªü</div>
          <div>ÁîüÊàêÊó∂Èó¥Ôºö{dayjs().format('YYYY-MM-DD HH:mm:ss')}</div>
        </div>
      </Card>

      <style jsx>{`
        @media print {
          .ant-btn,
          .ant-pagination,
          .no-print {
            display: none !important;
          }
          
          .assignment-detail-table .ant-table {
            font-size: 12px;
          }
          
          .assignment-detail-table .ant-table-thead > tr > th {
            background: #f5f5f5 !important;
            -webkit-print-color-adjust: exact;
          }
        }
      `}</style>
    </div>
  );
};

export default AssignmentTable; 