<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°Cookieè®¤è¯æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info-box {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .cookie-item {
            background: white;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .localStorage-item {
            background: #fff5cd;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            border-left: 4px solid #f39c12;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç®¡ç†åå°Cookieè®¤è¯æµ‹è¯•ç³»ç»Ÿ</h1>
        
        <div class="info-box">
            <h4>ğŸ“‹ æµ‹è¯•ç›®çš„</h4>
            <p>éªŒè¯ç®¡ç†åå°Cookie-onlyè®¤è¯æ¨¡å¼å’Œä¸ç”¨æˆ·ç«¯çš„å®Œå…¨éš”ç¦»ï¼š</p>
            <ul>
                <li>âœ… ç®¡ç†åå°ä½¿ç”¨ä¸“ç”¨Cookieåç§°ï¼ˆadminToken, adminRefreshToken, adminUserInfoï¼‰</li>
                <li>âœ… localStorageä½¿ç”¨admin_å‰ç¼€éš”ç¦»</li>
                <li>âœ… ä¸¤ä¸ªç³»ç»Ÿäº’ä¸å¹²æ‰°</li>
                <li>âœ… Cookie-onlyæ¨¡å¼å®‰å…¨æ€§éªŒè¯</li>
            </ul>
        </div>

        <!-- ç®¡ç†åå°è®¤è¯çŠ¶æ€ -->
        <div class="section">
            <h3>ğŸ” ç®¡ç†åå°è®¤è¯çŠ¶æ€æ£€æŸ¥</h3>
            <button class="btn-primary" onclick="checkAdminAuth()">æ£€æŸ¥ç®¡ç†åå°è®¤è¯çŠ¶æ€</button>
            <button class="btn-warning" onclick="showAdminCookies()">æ˜¾ç¤ºç®¡ç†åå°Cookie</button>
            <button class="btn-warning" onclick="showAdminLocalStorage()">æ˜¾ç¤ºç®¡ç†åå°localStorage</button>
            <div id="adminAuthStatus"></div>
        </div>

        <!-- ç®¡ç†åå°ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h3>ğŸš€ ç®¡ç†åå°ç™»å½•æµ‹è¯•</h3>
            <input type="text" id="adminUsername" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å" value="admin" style="padding: 8px; margin: 5px;">
            <input type="password" id="adminPassword" placeholder="ç®¡ç†å‘˜å¯†ç " value="123456" style="padding: 8px; margin: 5px;">
            <br>
            <button class="btn-success" onclick="adminLogin()">ç®¡ç†åå°ç™»å½•</button>
            <button class="btn-danger" onclick="adminLogout()">ç®¡ç†åå°ç™»å‡º</button>
            <div id="adminLoginStatus"></div>
        </div>

        <!-- APIæµ‹è¯• -->
        <div class="section">
            <h3>ğŸŒ ç®¡ç†åå°APIæµ‹è¯•</h3>
            <button class="btn-primary" onclick="testAdminApi()">æµ‹è¯•ç®¡ç†åå°API</button>
            <button class="btn-primary" onclick="testEmployeeList()">æµ‹è¯•å‘˜å·¥åˆ—è¡¨API</button>
            <div id="adminApiStatus"></div>
        </div>

        <!-- éš”ç¦»éªŒè¯ -->
        <div class="section">
            <h3>ğŸ›¡ï¸ éš”ç¦»éªŒè¯</h3>
            <button class="btn-warning" onclick="checkIsolation()">æ£€æŸ¥å­˜å‚¨éš”ç¦»</button>
            <button class="btn-danger" onclick="clearAdminAuth()">æ¸…ç†ç®¡ç†åå°è®¤è¯</button>
            <div id="isolationStatus"></div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="section">
            <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
            <button class="btn-primary" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';

        // æ£€æŸ¥ç®¡ç†åå°è®¤è¯çŠ¶æ€
        async function checkAdminAuth() {
            const statusDiv = document.getElementById('adminAuthStatus');
            statusDiv.innerHTML = '<div class="status">ğŸ” æ£€æŸ¥ç®¡ç†åå°è®¤è¯çŠ¶æ€...</div>';

            try {
                // æ£€æŸ¥Cookieä¸­çš„ç®¡ç†å‘˜token
                const adminCookies = getAdminCookies();
                const hasAdminToken = adminCookies.adminToken || adminCookies.adminAuthToken || adminCookies.admin_token;
                
                // æ£€æŸ¥localStorageä¸­çš„ç®¡ç†åå°æ•°æ®
                const adminLocalStorage = getAdminLocalStorage();
                
                let statusHtml = '<h4>ç®¡ç†åå°è®¤è¯çŠ¶æ€ï¼š</h4>';
                
                if (hasAdminToken) {
                    statusHtml += '<div class="status success">âœ… Cookieä¸­æ‰¾åˆ°ç®¡ç†å‘˜Token</div>';
                    statusHtml += `<div class="cookie-item">adminToken: ${hasAdminToken.substring(0, 20)}...</div>`;
                } else {
                    statusHtml += '<div class="status error">âŒ Cookieä¸­æœªæ‰¾åˆ°ç®¡ç†å‘˜Token</div>';
                }
                
                if (Object.keys(adminLocalStorage).length > 0) {
                    statusHtml += '<div class="status warning">âš ï¸ localStorageä¸­æœ‰ç®¡ç†åå°æ•°æ®ï¼ˆCookieæ¨¡å¼åº”æœ€å°åŒ–ï¼‰</div>';
                    Object.entries(adminLocalStorage).forEach(([key, value]) => {
                        const displayValue = typeof value === 'string' && value.length > 30 ? 
                                           value.substring(0, 30) + '...' : value;
                        statusHtml += `<div class="localStorage-item">${key}: ${displayValue}</div>`;
                    });
                } else {
                    statusHtml += '<div class="status success">âœ… localStorageä¸­æ— ç®¡ç†åå°æ•°æ®ï¼ˆCookie-onlyæ¨¡å¼æ­£å¸¸ï¼‰</div>';
                }

                statusDiv.innerHTML = statusHtml;

            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ç®¡ç†åå°ç™»å½•
        async function adminLogin() {
            const statusDiv = document.getElementById('adminLoginStatus');
            statusDiv.innerHTML = '<div class="status">ğŸš€ ç®¡ç†åå°ç™»å½•ä¸­...</div>';

            try {
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;

                const response = await fetch(`${API_BASE_URL}/admin/employee/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // é‡è¦ï¼šç¡®ä¿å‘é€å’Œæ¥æ”¶Cookie
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                console.log('ç®¡ç†åå°ç™»å½•å“åº”:', result);

                if (result.code === 1) {
                    statusDiv.innerHTML = `
                        <div class="status success">âœ… ç®¡ç†åå°ç™»å½•æˆåŠŸï¼</div>
                        <div class="info-box">
                            <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong><br>
                            ID: ${result.data.id}<br>
                            ç”¨æˆ·å: ${result.data.userName}<br>
                            å§“å: ${result.data.name}<br>
                            Token: ${result.data.token.substring(0, 20)}...
                        </div>
                    `;
                    
                    // ç­‰å¾…ä¸€ä¸‹è®©Cookieç”Ÿæ•ˆï¼Œç„¶åæ£€æŸ¥è®¤è¯çŠ¶æ€
                    setTimeout(checkAdminAuth, 500);
                } else {
                    statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°ç™»å½•å¤±è´¥: ${result.msg}</div>`;
                }

            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ç®¡ç†åå°ç™»å‡º
        async function adminLogout() {
            const statusDiv = document.getElementById('adminLoginStatus');
            statusDiv.innerHTML = '<div class="status">ğŸšª ç®¡ç†åå°ç™»å‡ºä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/employee/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const result = await response.json();
                console.log('ç®¡ç†åå°ç™»å‡ºå“åº”:', result);

                if (result.code === 1) {
                    statusDiv.innerHTML = '<div class="status success">âœ… ç®¡ç†åå°ç™»å‡ºæˆåŠŸï¼</div>';
                    setTimeout(checkAdminAuth, 500);
                } else {
                    statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°ç™»å‡ºå¤±è´¥: ${result.msg}</div>`;
                }

            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°ç™»å‡ºè¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•ç®¡ç†åå°API
        async function testAdminApi() {
            const statusDiv = document.getElementById('adminApiStatus');
            statusDiv.innerHTML = '<div class="status">ğŸŒ æµ‹è¯•ç®¡ç†åå°API...</div>';

            try {
                // æµ‹è¯•éœ€è¦è®¤è¯çš„ç®¡ç†åå°API
                const response = await fetch(`${API_BASE_URL}/admin/employee/page?page=1&pageSize=10`, {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('ç®¡ç†åå°APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.status === 401) {
                    statusDiv.innerHTML = '<div class="status error">âŒ ç®¡ç†åå°APIè¿”å›401ï¼šæœªè®¤è¯æˆ–Tokenè¿‡æœŸ</div>';
                    return;
                }

                const result = await response.json();
                console.log('ç®¡ç†åå°APIå“åº”:', result);

                if (result.code === 1) {
                    statusDiv.innerHTML = `
                        <div class="status success">âœ… ç®¡ç†åå°APIè°ƒç”¨æˆåŠŸï¼</div>
                        <div class="info-box">Cookie-onlyè®¤è¯å·¥ä½œæ­£å¸¸</div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°APIå¤±è´¥: ${result.msg}</div>`;
                }

            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç®¡ç†åå°APIè¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•å‘˜å·¥åˆ—è¡¨API
        async function testEmployeeList() {
            const statusDiv = document.getElementById('adminApiStatus');
            statusDiv.innerHTML = '<div class="status">ğŸ‘¥ è·å–å‘˜å·¥åˆ—è¡¨...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/employee/page?page=1&pageSize=5`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    statusDiv.innerHTML = '<div class="status error">âŒ å‘˜å·¥åˆ—è¡¨APIè¿”å›401ï¼šç®¡ç†å‘˜è®¤è¯å¤±è´¥</div>';
                    return;
                }

                const result = await response.json();
                
                if (result.code === 1) {
                    let html = '<div class="status success">âœ… å‘˜å·¥åˆ—è¡¨è·å–æˆåŠŸï¼</div>';
                    html += '<div class="info-box">';
                    html += `<strong>æ€»è®°å½•æ•°ï¼š</strong>${result.data.total}<br>`;
                    html += '<strong>å‘˜å·¥åˆ—è¡¨ï¼š</strong><br>';
                    
                    if (result.data.records && result.data.records.length > 0) {
                        result.data.records.forEach(emp => {
                            html += `- ${emp.name} (${emp.username})<br>`;
                        });
                    }
                    html += '</div>';
                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = `<div class="status error">âŒ å‘˜å·¥åˆ—è¡¨è·å–å¤±è´¥: ${result.msg}</div>`;
                }

            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ å‘˜å·¥åˆ—è¡¨è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–ç®¡ç†åå°Cookie
        function getAdminCookies() {
            const cookies = {};
            document.cookie.split(';').forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name && (name.startsWith('admin') || name.includes('admin'))) {
                    cookies[name] = value;
                }
            });
            return cookies;
        }

        // è·å–ç®¡ç†åå°localStorage
        function getAdminLocalStorage() {
            const adminData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('admin_')) {
                    adminData[key] = localStorage.getItem(key);
                }
            }
            return adminData;
        }

        // æ˜¾ç¤ºç®¡ç†åå°Cookie
        function showAdminCookies() {
            const statusDiv = document.getElementById('adminAuthStatus');
            const adminCookies = getAdminCookies();
            
            let html = '<h4>ğŸª ç®¡ç†åå°Cookieï¼š</h4>';
            
            if (Object.keys(adminCookies).length > 0) {
                Object.entries(adminCookies).forEach(([name, value]) => {
                    const displayValue = value && value.length > 50 ? 
                                       value.substring(0, 50) + '...' : (value || 'ç©º');
                    html += `<div class="cookie-item"><strong>${name}:</strong> ${displayValue}</div>`;
                });
            } else {
                html += '<div class="status warning">âš ï¸ æœªæ‰¾åˆ°ç®¡ç†åå°Cookie</div>';
            }
            
            statusDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºç®¡ç†åå°localStorage
        function showAdminLocalStorage() {
            const statusDiv = document.getElementById('adminAuthStatus');
            const adminData = getAdminLocalStorage();
            
            let html = '<h4>ğŸ’¾ ç®¡ç†åå°localStorageï¼š</h4>';
            
            if (Object.keys(adminData).length > 0) {
                Object.entries(adminData).forEach(([key, value]) => {
                    const displayValue = value && value.length > 50 ? 
                                       value.substring(0, 50) + '...' : (value || 'ç©º');
                    html += `<div class="localStorage-item"><strong>${key}:</strong> ${displayValue}</div>`;
                });
            } else {
                html += '<div class="status success">âœ… æ— ç®¡ç†åå°localStorageæ•°æ®ï¼ˆCookie-onlyæ¨¡å¼æ­£å¸¸ï¼‰</div>';
            }
            
            statusDiv.innerHTML = html;
        }

        // æ£€æŸ¥éš”ç¦»
        function checkIsolation() {
            const statusDiv = document.getElementById('isolationStatus');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ç«¯æ•°æ®
            const userCookies = [];
            const userLocalStorage = [];
            
            document.cookie.split(';').forEach(cookie => {
                const [name] = cookie.trim().split('=');
                if (name && !name.startsWith('admin') && (name.includes('auth') || name.includes('token') || name === 'userInfo')) {
                    userCookies.push(name);
                }
            });
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && !key.startsWith('admin_') && (key.includes('token') || key.includes('user') || key.includes('agent'))) {
                    userLocalStorage.push(key);
                }
            }
            
            let html = '<h4>ğŸ›¡ï¸ éš”ç¦»æ£€æŸ¥ç»“æœï¼š</h4>';
            
            if (userCookies.length === 0 && userLocalStorage.length === 0) {
                html += '<div class="status success">âœ… å®Œç¾éš”ç¦»ï¼šæœªå‘ç°ç”¨æˆ·ç«¯è®¤è¯æ•°æ®</div>';
            } else {
                html += '<div class="status warning">âš ï¸ å‘ç°ç”¨æˆ·ç«¯è®¤è¯æ•°æ®ï¼ˆå¯èƒ½å­˜åœ¨å†²çªï¼‰ï¼š</div>';
                if (userCookies.length > 0) {
                    html += `<div class="cookie-item">ç”¨æˆ·ç«¯Cookie: ${userCookies.join(', ')}</div>`;
                }
                if (userLocalStorage.length > 0) {
                    html += `<div class="localStorage-item">ç”¨æˆ·ç«¯localStorage: ${userLocalStorage.join(', ')}</div>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }

        // æ¸…ç†ç®¡ç†åå°è®¤è¯
        function clearAdminAuth() {
            const statusDiv = document.getElementById('isolationStatus');
            
            // æ¸…ç†ç®¡ç†åå°localStorage
            const adminKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('admin_')) {
                    adminKeys.push(key);
                }
            }
            
            adminKeys.forEach(key => localStorage.removeItem(key));
            
            statusDiv.innerHTML = `
                <div class="status success">âœ… ç®¡ç†åå°è®¤è¯æ•°æ®å·²æ¸…ç†</div>
                <div class="info-box">
                    å·²æ¸…ç† ${adminKeys.length} ä¸ªlocalStorageé¡¹ç›®<br>
                    Cookieéœ€è¦é€šè¿‡æœåŠ¡ç«¯ç™»å‡ºæ¸…ç†
                </div>
            `;
            
            setTimeout(checkAdminAuth, 500);
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const statusDiv = document.getElementById('debugInfo');
            
            const allCookies = {};
            document.cookie.split(';').forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) {
                    allCookies[name] = value ? (value.length > 30 ? value.substring(0, 30) + '...' : value) : 'ç©º';
                }
            });
            
            const allLocalStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    const value = localStorage.getItem(key);
                    allLocalStorage[key] = value ? (value.length > 30 ? value.substring(0, 30) + '...' : value) : 'ç©º';
                }
            }
            
            let html = '<h4>ğŸ”§ å®Œæ•´è°ƒè¯•ä¿¡æ¯ï¼š</h4>';
            
            html += '<h5>ğŸª æ‰€æœ‰Cookieï¼š</h5>';
            if (Object.keys(allCookies).length > 0) {
                Object.entries(allCookies).forEach(([name, value]) => {
                    const isAdmin = name.startsWith('admin') || name.includes('admin');
                    const className = isAdmin ? 'cookie-item' : 'localStorage-item';
                    html += `<div class="${className}">${name}: ${value}</div>`;
                });
            } else {
                html += '<div class="status">æ— Cookie</div>';
            }
            
            html += '<h5>ğŸ’¾ æ‰€æœ‰localStorageï¼š</h5>';
            if (Object.keys(allLocalStorage).length > 0) {
                Object.entries(allLocalStorage).forEach(([key, value]) => {
                    const isAdmin = key.startsWith('admin_');
                    const className = isAdmin ? 'localStorage-item' : 'cookie-item';
                    html += `<div class="${className}">${key}: ${value}</div>`;
                });
            } else {
                html += '<div class="status">æ— localStorageæ•°æ®</div>';
            }
            
            statusDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkAdminAuth();
        };
    </script>
</body>
</html> 